# GitLab CI/CD Pipeline using GitLab Runner
# Designed for self-hosted GitLab Runner

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# Deploy to staging (develop branch)
deploy_staging:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  tags:
    - docker
  before_script:
    - apk add --no-cache docker-compose git
    - docker info
  script:
    - echo "Building and deploying to staging..."
    - echo "Current directory:"
    - pwd
    - echo "Files:"
    - ls -la
    - docker-compose --version
    # Stop any existing containers first
    - docker-compose -f docker-compose.yml down || true
    # Build with environment variables
    - OPENWEATHER_API_KEY="$OPENWEATHER_API_KEY" GOOGLE_MAPS_API_KEY="$GOOGLE_MAPS_API_KEY" NEXT_PUBLIC_MAPBOX_API_KEY="$NEXT_PUBLIC_MAPBOX_API_KEY" docker-compose -f docker-compose.yml build
    # Start containers in detached mode
    - OPENWEATHER_API_KEY="$OPENWEATHER_API_KEY" GOOGLE_MAPS_API_KEY="$GOOGLE_MAPS_API_KEY" NEXT_PUBLIC_MAPBOX_API_KEY="$NEXT_PUBLIC_MAPBOX_API_KEY" docker-compose -f docker-compose.yml up -d
    # Show container status
    - docker-compose -f docker-compose.yml ps
    - echo "Staging deployment completed!"
    - echo "Access at: http://137.43.49.26:3030"
  environment:
    name: staging
    url: http://137.43.49.26:3030
  only:
    - develop

# Deploy to production (main branch)
deploy_production:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  tags:
    - docker
  before_script:
    - apk add --no-cache docker-compose git
    - docker info
  script:
    - echo "Building and deploying to production..."
    - echo "Current directory:"
    - pwd
    - echo "Files:"
    - ls -la
    - docker-compose --version
    # Stop any existing containers first
    - docker-compose -f docker-compose.prod.yml down || true
    # Build with environment variables for production
    - OPENWEATHER_API_KEY="$OPENWEATHER_API_KEY" GOOGLE_MAPS_API_KEY="$GOOGLE_MAPS_API_KEY" NEXT_PUBLIC_MAPBOX_API_KEY="$NEXT_PUBLIC_MAPBOX_API_KEY" WEBAPP_PORT=8080 ML_API_PORT=5001 docker-compose -f docker-compose.prod.yml build
    # Start containers in detached mode
    - OPENWEATHER_API_KEY="$OPENWEATHER_API_KEY" GOOGLE_MAPS_API_KEY="$GOOGLE_MAPS_API_KEY" NEXT_PUBLIC_MAPBOX_API_KEY="$NEXT_PUBLIC_MAPBOX_API_KEY" WEBAPP_PORT=8080 ML_API_PORT=5001 docker-compose -f docker-compose.prod.yml up -d
    # Show container status
    - docker-compose -f docker-compose.prod.yml ps
    - echo "Production deployment completed!"
    - echo "Access at: http://137.43.49.26:8080"
  environment:
    name: production
    url: http://137.43.49.26:8080
  only:
    - main
  when: manual
