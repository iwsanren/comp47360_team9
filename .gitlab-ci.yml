default:
  tags:
    - shell

stages:
  - quality-check
  - deploy

quality_check:
  stage: quality-check
  tags:
    - shell
  script:
    - echo "ðŸ” Running quality checks..."
    - echo "ðŸ§¹ Cleaning Docker cache..."
    - docker system prune -af || true
    - echo "ðŸ“ Validating project structure..."
    - test -f "webapp/package.json" && echo "âœ… Frontend package.json exists"
    - test -f "ml/requirements.txt" && echo "âœ… ML requirements.txt exists"
    - test -f "docker-compose.yml" && echo "âœ… Docker compose config exists"
    - echo "âœ… Quality checks completed"
  only:
    - feature/delete-user-context
    - develop
    - main

deploy_app:
  stage: deploy
  tags:
    - shell
  before_script:
    - docker --version
    - docker-compose --version
  script:
    - echo "Building and deploying to staging..."
    - echo "ðŸ“Š Checking disk space..."
    - df -h /
    - AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
    - echo "Available space: ${AVAILABLE_SPACE}KB"
    - echo "ðŸ§¹ Cleaning up before deployment..."
    - sudo docker system prune -af || echo "Docker cleanup failed"
    - sudo docker image prune -af || echo "Docker image cleanup failed"
    - sudo docker volume prune -f || echo "Docker volume cleanup failed"
    - sudo rm -rf /tmp/team9-deploy || echo "No previous deployment to clean"
    - echo "ðŸ“Š Disk space after cleanup:"
    - df -h /
    - echo "ðŸ“ Setting up deployment directory..."
    - mkdir -p /tmp/team9-deploy/staging
    - echo "ðŸ“‹ Syncing project files (excluding data folder)..."
    - rsync -av --exclude='.git' --exclude='.gitlab' --exclude='node_modules' --exclude='data/' --exclude='backup' --exclude='*.log' --exclude='.DS_Store' --exclude='Thumbs.db' ./ /tmp/team9-deploy/staging/
    - cd /tmp/team9-deploy/staging
    - echo "Creating .env file..."
    - echo "OPENWEATHER_API_KEY=$OPENWEATHER_API_KEY" > .env
    - echo "GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY" >> .env
    - echo "NEXT_PUBLIC_MAPBOX_API_KEY=$NEXT_PUBLIC_MAPBOX_API_KEY" >> .env
    - echo "JWT_SECRET=$JWT_SECRET" >> .env
    - echo "NODE_ENV=development" >> .env
    - echo "FLASK_ENV=production" >> .env
    - echo "Stopping existing containers..."
    - sudo docker-compose down || true
    - echo "Building containers..."
    - sudo docker-compose build --no-cache
    - echo "Starting containers..."
    - sudo docker-compose up -d
    - echo "Container status:"
    - sudo docker-compose ps
    - echo "Recent logs:"
    - sudo docker-compose logs --tail=30
    - echo "Staging deployment completed!"
    - echo "Access at http://137.43.49.26:3030"
    - echo "ðŸ§¹ Cleaning up deployment files..."
    - sudo rm -rf /tmp/team9-deploy
    - echo "Final disk space:"
    - df -h /
  environment:
    name: staging
    url: http://137.43.49.26:3030
  only:
    - develop
    - feature/delete-user-context
    - main
